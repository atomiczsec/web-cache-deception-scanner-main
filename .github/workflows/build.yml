name: Build Extension

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/**/*.java'
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: Make gradlew executable
      run: chmod +x ./gradlew
      
    - name: Build with Gradle
      run: ./gradlew clean build
      
    - name: Get version from build.gradle
      id: get_version
      run: |
        VERSION=$(grep "Implementation-Version" build.gradle | sed "s/.*'\(.*\)'.*/\1/")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: extension-jar
        path: build/libs/*.jar
        retention-days: 30

    - name: Get latest release version and increment
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      id: get_next_version
      run: |
        # Get all releases and extract version numbers, excluding 'latest' tag
        RELEASES=$(gh release list --limit 100 --json tagName)
        
        # Extract version numbers (format: v2.0, v2.1, etc.), exclude 'latest', and find the highest
        LATEST_VERSION=$(echo "$RELEASES" | jq -r '.[].tagName' | grep -vE '^latest$' | grep -E '^v[0-9]+\.[0-9]+$' | sed 's/^v//' | sort -t. -k1,1nr -k2,2nr | head -n1)
        
        # If no releases exist, start with 2.0
        if [ -z "$LATEST_VERSION" ]; then
          LATEST_VERSION="2.0"
        fi
        
        # Increment minor version (e.g., 2.0 -> 2.1, 2.1 -> 2.2)
        MAJOR=$(echo "$LATEST_VERSION" | cut -d. -f1)
        MINOR=$(echo "$LATEST_VERSION" | cut -d. -f2)
        NEW_MINOR=$((MINOR + 1))
        NEW_VERSION="${MAJOR}.${NEW_MINOR}"
        
        echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "tag=v${NEW_VERSION}" >> $GITHUB_OUTPUT
        echo "Latest version: $LATEST_VERSION"
        echo "New version: $NEW_VERSION"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create new auto-versioned release
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_next_version.outputs.tag }}
        name: Release v${{ steps.get_next_version.outputs.new_version }}
        files: build/libs/*.jar
        body: |
          ## Web Cache Deception Scanner v${{ steps.get_next_version.outputs.new_version }}

          Built automatically from `${{ github.ref_name }}` at `${{ github.sha }}`.

          ### Installation
          1. Download the `web-cache-deception-scanner-all.jar` file
          2. In Burp Suite, go to **Extender** tab
          3. Click **Add** and select the JAR file
          4. Check the **Output** tab for loading confirmation
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: build/libs/*.jar
        name: Release v${{ steps.get_version.outputs.version }}
        body: |
          ## Web Cache Deception Scanner v${{ steps.get_version.outputs.version }}
          
          ### Changes
          - See commit history for details
          
          ### Installation
          1. Download the `web-cache-deception-scanner-all.jar` file
          2. In Burp Suite, go to **Extender** tab
          3. Click **Add** and select the JAR file
          4. Check the **Output** tab for loading confirmation
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

